import { router } from '@kit.ArkUI';
import {
  LotteryStick,
  drawLotteryStick,
  getLevelText,
  getLevelColor
} from '../models/LotteryStick';

/**
 * æŠ½ç­¾é¡µé¢
 * æä¾›æ‘‡ç­¾åŠ¨ç”»å’ŒæŠ½ç­¾ç»“æžœå±•ç¤º
 */
@Entry
@Component
struct LotteryPage {
  @State isShaking: boolean = false;          // æ˜¯å¦æ­£åœ¨æ‘‡ç­¾
  @State hasDrawn: boolean = false;            // æ˜¯å¦å·²ç»æŠ½ç­¾
  @State drawnStick: LotteryStick | null = null; // æŠ½ä¸­çš„ç­¾
  @State showResult: boolean = false;          // æ˜¯å¦æ˜¾ç¤ºç»“æžœ
  @State userQuestion: string = '';            // ç”¨æˆ·é—®é¢˜
  @State shakeAngle: number = 0;               // æ‘‡åŠ¨è§’åº¦
  @State tubeScale: number = 1;                // ç­¾ç­’ç¼©æ”¾
  @State stickOffset: number = 0;              // ç­¾æ¡åç§»
  @State showStick: boolean = false;           // æ˜¯å¦æ˜¾ç¤ºç­¾æ¡
  private shakeTimer: number = -1;

  aboutToDisappear() {
    if (this.shakeTimer !== -1) {
      clearInterval(this.shakeTimer);
    }
  }

  /**
   * å¼€å§‹æ‘‡ç­¾
   */
  startShaking() {
    if (this.isShaking || this.hasDrawn) {
      return;
    }

    this.isShaking = true;
    this.hasDrawn = false;
    this.showResult = false;
    this.showStick = false;
    this.stickOffset = 0;

    // æ‘‡åŠ¨åŠ¨ç”» - å¢žå¼ºæ•ˆæžœ
    let count = 0;
    this.shakeTimer = setInterval(() => {
      // éšæœºè§’åº¦å’Œå¹…åº¦ï¼Œæ¨¡æ‹ŸçœŸå®žæ‘‡åŠ¨
      const intensity = 1 - (count / 30); // é€æ¸å‡å¼±
      this.shakeAngle = (Math.random() - 0.5) * 40 * intensity; // -20åˆ°20åº¦
      this.tubeScale = 1 + (Math.random() - 0.5) * 0.1 * intensity; // è½»å¾®ç¼©æ”¾
      
      count++;

      if (count >= 30) { // æ‘‡åŠ¨3ç§’åŽåœæ­¢
        clearInterval(this.shakeTimer);
        this.showStickAnimation();
      }
    }, 100);
  }

  /**
   * æ˜¾ç¤ºç­¾æ¡å¼¹å‡ºåŠ¨ç”»
   */
  showStickAnimation() {
    this.shakeAngle = 0;
    this.tubeScale = 1;
    this.showStick = true;
    
    // ç­¾æ¡ä»Žç­¾ç­’ä¸­å¼¹å‡º
    let offset = 0;
    const popTimer = setInterval(() => {
      offset += 5;
      this.stickOffset = offset;
      
      if (offset >= 50) { // å¼¹å‡º50px
        clearInterval(popTimer);
        setTimeout(() => {
          this.completeShaking();
        }, 800);
      }
    }, 30);
  }

  /**
   * å®Œæˆæ‘‡ç­¾ï¼Œæ˜¾ç¤ºç»“æžœ
   */
  completeShaking() {
    this.shakeAngle = 0;
    this.isShaking = false;
    
    // æŠ½å–ç­¾æ–‡
    this.drawnStick = drawLotteryStick();
    this.hasDrawn = true;

    // å»¶è¿Ÿæ˜¾ç¤ºç»“æžœï¼Œå¢žåŠ æ‚¬å¿µ
    setTimeout(() => {
      this.showResult = true;
    }, 500);
  }

  /**
   * æŸ¥çœ‹è¯¦ç»†è§£ç­¾
   */
  viewDetail() {
    if (!this.drawnStick) return;

    router.pushUrl({
      url: 'pages/LotteryDetailPage',
      params: {
        stick: this.drawnStick,
        question: this.userQuestion
      }
    });
  }

  /**
   * é‡æ–°æŠ½ç­¾
   */
  resetDraw() {
    this.hasDrawn = false;
    this.showResult = false;
    this.drawnStick = null;
    this.shakeAngle = 0;
    this.tubeScale = 1;
    this.stickOffset = 0;
    this.showStick = false;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor($r('app.color.text_primary'))
          .fontWeight(FontWeight.Bold)
          .onClick(() => {
            router.back();
          })

        Text('è§‚éŸ³çµç­¾')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .margin({ left: 12 })
      }
      .width('100%')
      .padding({ top: 20, left: 20, right: 20, bottom: 10 })

      Scroll() {
        Column() {
          // è¯´æ˜Žæ–‡å­—
          if (!this.hasDrawn) {
            Text('è¯šå¿ƒè¯šæ„ï¼Œå¿ƒè¯šåˆ™çµ')
              .fontSize(16)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 20, bottom: 10 })
              .opacity(0.8)

            // é—®é¢˜è¾“å…¥
            Column() {
              Text('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ˆå¯é€‰ï¼‰')
                .fontSize(14)
                .fontColor($r('app.color.text_secondary'))
                .margin({ bottom: 8 })
                .width('100%')
                .textAlign(TextAlign.Start)

              TextInput({ placeholder: 'ä¾‹å¦‚ï¼šäº‹ä¸šå‘å±•ã€æ„Ÿæƒ…è¿åŠ¿ç­‰' })
                .width('100%')
                .height(50)
                .backgroundColor($r('app.color.background_secondary'))
                .borderRadius(12)
                .padding({ left: 16, right: 16 })
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
                .onChange((value: string) => {
                  this.userQuestion = value;
                })
            }
            .width('90%')
            .margin({ top: 10, bottom: 30 })
          }

          // ç­¾ç­’åŒºåŸŸ
          Column() {
            if (!this.hasDrawn) {
              // æ‘‡ç­¾åŠ¨ç”»åŒºåŸŸ
              Column() {
                // ç­¾ç­’å®¹å™¨
                Stack({ alignContent: Alignment.Top }) {
                  // ç­¾ç­’ä¸»ä½“
                  Column() {
                    // ç­¾ç­’å£éƒ¨
                    Column()
                      .width(100)
                      .height(15)
                      .backgroundColor('rgba(139, 92, 246, 0.3)')
                      .borderRadius({ topLeft: 8, topRight: 8 })
                      .border({
                        width: 2,
                        color: 'rgba(139, 92, 246, 0.5)'
                      })
                    
                    // ç­¾ç­’èº«
                    Column() {
                      Text('ðŸŽ‹')
                        .fontSize(100)
                    }
                    .width(120)
                    .height(180)
                    .backgroundColor('rgba(139, 92, 246, 0.15)')
                    .borderRadius(12)
                    .border({
                      width: 2,
                      color: 'rgba(139, 92, 246, 0.4)'
                    })
                    .justifyContent(FlexAlign.Center)
                    
                    Text('è§‚éŸ³çµç­¾')
                      .fontSize(14)
                      .fontColor($r('app.color.text_secondary'))
                      .margin({ top: 8 })
                      .fontWeight(FontWeight.Medium)
                  }
                  .rotate({ angle: this.shakeAngle })
                  .scale({ x: this.tubeScale, y: this.tubeScale })
                  .animation({
                    duration: 100,
                    curve: Curve.Friction
                  })

                  // å¼¹å‡ºçš„ç­¾æ¡
                  if (this.showStick) {
                    Column() {
                      Text('ðŸ“œ')
                        .fontSize(40)
                        .rotate({ angle: -15 })
                    }
                    .offset({ y: -this.stickOffset })
                    .opacity(this.showStick ? 1 : 0)
                    .animation({
                      duration: 300,
                      curve: Curve.EaseOut
                    })
                  }
                }
                .width(200)
                .height(250)
              }
              .margin({ top: 20, bottom: 40 })

              // æ‘‡ç­¾æç¤º
              Text(this.isShaking ? 'æ­£åœ¨æ‘‡ç­¾...' : 'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ‘‡ç­¾')
                .fontSize(16)
                .fontColor($r('app.color.text_secondary'))
                .margin({ bottom: 30 })
                .opacity(this.isShaking ? 1 : 0.6)

              // å¼€å§‹æ‘‡ç­¾æŒ‰é’®
              Button(this.isShaking ? 'æ‘‡ç­¾ä¸­...' : 'ðŸ™ å¼€å§‹æ‘‡ç­¾')
                .type(ButtonType.Normal)
                .backgroundColor(this.isShaking ? $r('app.color.button_secondary') : $r('app.color.button_primary'))
                .fontColor(Color.White)
                .fontSize(18)
                .width('80%')
                .height(50)
                .borderRadius(25)
                .enabled(!this.isShaking)
                .onClick(() => {
                  this.startShaking();
                })
            } else {
              // æŠ½ç­¾ç»“æžœæ˜¾ç¤º
              this.buildResult()
            }
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 40 })
      }
      .width('100%')
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_primary'))
  }

  /**
   * æž„å»ºæŠ½ç­¾ç»“æžœå±•ç¤º
   */
  @Builder
  buildResult() {
    Column() {
      // ç­¾æ–‡å¡ç‰‡
      Column() {
        // ç­¾å·å’Œç­‰çº§
        Text(this.drawnStick!.name + ' Â· ' + getLevelText(this.drawnStick!.level))
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(getLevelColor(this.drawnStick!.level))
          .margin({ bottom: 20 })

        // ç­¾æ–‡è¯—å¥
        Text(this.drawnStick!.poem)
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .lineHeight(28)
          .textAlign(TextAlign.Center)
          .width('100%')
          .margin({ bottom: 20 })
          .fontFamily('serif')

        // ç­¾æ–‡å«ä¹‰
        Text(this.drawnStick!.meaning)
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .textAlign(TextAlign.Center)
          .margin({ bottom: 10 })
      }
      .width('90%')
      .padding(24)
      .backgroundColor($r('app.color.background_secondary'))
      .borderRadius(16)
      .shadow({
        radius: 20,
        color: 'rgba(0,0,0,0.1)',
        offsetX: 0,
        offsetY: 4
      })
      .opacity(this.showResult ? 1 : 0)
      .animation({
        duration: 500,
        curve: Curve.EaseOut
      })

      // æ“ä½œæŒ‰é’®
      if (this.showResult) {
        Row() {
          Button('æŸ¥çœ‹è¯¦è§£')
            .type(ButtonType.Normal)
            .backgroundColor($r('app.color.button_primary'))
            .fontColor(Color.White)
            .fontSize(16)
            .height(48)
            .layoutWeight(1)
            .borderRadius(24)
            .margin({ right: 10 })
            .onClick(() => {
              this.viewDetail();
            })

          Button('é‡æ–°æŠ½ç­¾')
            .type(ButtonType.Normal)
            .backgroundColor($r('app.color.background_secondary'))
            .fontColor($r('app.color.text_primary'))
            .fontSize(16)
            .height(48)
            .layoutWeight(1)
            .borderRadius(24)
            .margin({ left: 10 })
            .onClick(() => {
              this.resetDraw();
            })
        }
        .width('90%')
        .margin({ top: 30 })
        .opacity(this.showResult ? 1 : 0)
        .animation({
          duration: 500,
          delay: 300,
          curve: Curve.EaseOut
        })
      }
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
  }
}
