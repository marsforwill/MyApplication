import { BaZiUtils, BaZiResult } from '../utils/BaZiUtils';
import router from '@ohos.router';
import { vibrator } from '@kit.SensorServiceKit';
import { promptAction } from '@kit.ArkUI';

@Entry
@Component
struct BaZiPage {
  @State selectedDate: Date = new Date();
  @State result: BaZiResult | null = null;
  @State analyzed: boolean = false;

  build() {
    Column() {
      // Header
      Row() {
        Text('‚Üê')
          .fontSize(24)
          .fontColor($r('app.color.text_primary'))
          .fontWeight(FontWeight.Bold)
          .margin({ right: 12 })
          .onClick(() => {
            router.back();
          })
        
        Text('ÂÖ´Â≠óÂàÜÊûê')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#F1F3F5')

      Scroll() {
        Column() {
          Text('ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂá∫ÁîüÊó•ÊúüÂíåÊó∂Èó¥')
            .fontSize(16)
            .margin({ top: 20, bottom: 10 })

          // Date Picker
          DatePicker({
            start: new Date('1900-01-01'),
            end: new Date('2100-12-31'),
            selected: this.selectedDate,
          })
            .onChange((value: DatePickerResult) => {
              this.selectedDate.setFullYear(value.year ?? 2000, value.month ?? 0, value.day ?? 1)
            })
            .height(150)

          // Time Picker
          TimePicker({
            selected: this.selectedDate,
          })
            .onChange((value: TimePickerResult) => {
              this.selectedDate.setHours(value.hour ?? 0, value.minute ?? 0)
            })
            .height(150)
            .margin({ top: 10 })

          Button('üîÆ ÂºÄÂßãÂàÜÊûê')
            .width('80%')
            .height(50)
            .margin({ top: 30 })
            .type(ButtonType.Normal)
            .backgroundColor($r('app.color.button_primary'))
            .fontColor(Color.White)
            .fontSize(16)
            .borderRadius(25)
            .onClick(() => {
              try {
                vibrator.startVibration({
                  type: 'time',
                  duration: 50
                }, {
                  usage: 'touch'
                });
              } catch (error) {
                console.error('Vibration error:', error);
              }
              
              this.result = BaZiUtils.analyze(this.selectedDate);
              this.analyzed = true;
              
              promptAction.showToast({
                message: '‚ú® ÂàÜÊûêÂÆåÊàê',
                duration: 1500
              });
            })

          if (this.analyzed) {
            Column() {
              Text('ÊÇ®ÁöÑÂÖ´Â≠óÊéíÁõòÁªìÊûúÔºö')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .margin({ top: 30, bottom: 20 })

              Grid() {
                GridItem() {
                  this.buildPillar('Âπ¥Êü±', this.result!.pillars[0])
                }

                GridItem() {
                  this.buildPillar('ÊúàÊü±', this.result!.pillars[1])
                }

                GridItem() {
                  this.buildPillar('Êó•Êü±', this.result!.pillars[2])
                }

                GridItem() {
                  this.buildPillar('Êó∂Êü±', this.result!.pillars[3])
                }
              }
              .columnsTemplate('1fr 1fr 1fr 1fr')
              .width('100%')
              .height(120)
              .backgroundColor('#FFF8E1')
              .borderRadius(10)
              .padding(10)

              // Five Elements Summary
              Column() {
                Text('‰∫îË°åÁªüËÆ°')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 20, bottom: 10 })
                  .width('100%')
                
                Flex({ wrap: FlexWrap.Wrap }) {
                  this.buildElementCount('Èáë', this.result!.elementCounts.get('Èáë') || 0)
                  this.buildElementCount('Êú®', this.result!.elementCounts.get('Êú®') || 0)
                  this.buildElementCount('Ê∞¥', this.result!.elementCounts.get('Ê∞¥') || 0)
                  this.buildElementCount('ÁÅ´', this.result!.elementCounts.get('ÁÅ´') || 0)
                  this.buildElementCount('Âúü', this.result!.elementCounts.get('Âúü') || 0)
                }
              }
              .width('100%')

              // Analysis
              Column() {
                Text('Êó•ÂÖÉÂàÜÊûê')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 20, bottom: 10 })
                  .width('100%')
                
                Text(this.result!.dayMasterAnalysis)
                  .fontSize(14)
                  .lineHeight(20)
                  .backgroundColor('#F0F0F0')
                  .padding(10)
                  .borderRadius(8)
                  .width('100%')
              }
              .width('100%')

              // Zodiac and Lucky Info
              Column() {
                Text('Ë∂£Âë≥ËøêÂäø')
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .margin({ top: 20, bottom: 10 })
                  .width('100%')
                
                Row() {
                  Column() {
                    Text('ÊòüÂ∫ß')
                      .fontSize(12)
                      .fontColor(Color.Gray)
                    Text(this.result!.zodiac)
                      .fontSize(18)
                      .fontWeight(FontWeight.Bold)
                      .margin({ top: 4 })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Center)
                  .backgroundColor('#F0F0F0')
                  .padding(10)
                  .borderRadius(8)
                  .margin({ right: 8 })

                  Column() {
                    Text('Âπ∏ËøêËâ≤')
                      .fontSize(12)
                      .fontColor(Color.Gray)
                    Text(this.result!.luckyColor)
                      .fontSize(18)
                      .fontWeight(FontWeight.Bold)
                      .fontColor(this.getLuckyColorValue(this.result!.luckyColor))
                      .margin({ top: 4 })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Center)
                  .backgroundColor('#F0F0F0')
                  .padding(10)
                  .borderRadius(8)
                  .margin({ right: 8 })

                  Column() {
                    Text('Âπ∏ËøêÊï∞Â≠ó')
                      .fontSize(12)
                      .fontColor(Color.Gray)
                    Text(this.result!.luckyNumber.toString())
                      .fontSize(18)
                      .fontWeight(FontWeight.Bold)
                      .margin({ top: 4 })
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Center)
                  .backgroundColor('#F0F0F0')
                  .padding(10)
                  .borderRadius(8)
                }
                .width('100%')
              }
              .width('100%')
            }
            .width('100%')
            .padding(16)
          }
        }
        .width('100%')
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildPillar(title: string, pillar: string) {
    Column() {
      Text(title)
        .fontSize(14)
        .fontColor(Color.Gray)
      
      Row() {
        Column() {
          Text(pillar.charAt(0))
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
          Text(BaZiUtils.getElement(pillar.charAt(0)))
            .fontSize(10)
            .fontColor(this.getElementColor(BaZiUtils.getElement(pillar.charAt(0))))
        }
        .margin({ right: 4 })

        Column() {
          Text(pillar.charAt(1))
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
          Text(BaZiUtils.getElement(pillar.charAt(1)))
            .fontSize(10)
            .fontColor(this.getElementColor(BaZiUtils.getElement(pillar.charAt(1))))
        }
      }
      .margin({ top: 5 })
    }
  }

  @Builder
  buildElementCount(element: string, count: number) {
    Row() {
      Text(element + ': ')
        .fontSize(14)
        .fontColor(this.getElementColor(element))
      Text(count.toString())
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
    }
    .margin({ right: 16, bottom: 8 })
    .padding({ top: 4, bottom: 4, left: 8, right: 8 })
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .border({ width: 1, color: '#E0E0E0' })
  }

  getElementColor(element: string): string {
    switch (element) {
      case 'Èáë': return '#FFD700'; // Gold
      case 'Êú®': return '#228B22'; // Forest Green
      case 'Ê∞¥': return '#1E90FF'; // Dodger Blue
      case 'ÁÅ´': return '#FF4500'; // Orange Red
      case 'Âúü': return '#8B4513'; // Saddle Brown
      default: return '#000000';
    }
  }

  getLuckyColorValue(colorName: string): string {
    switch (colorName) {
      case 'Á∫¢Ëâ≤': return '#FF0000';
      case 'Ê©ôËâ≤': return '#FFA500';
      case 'ÈªÑËâ≤': return '#FFD700';
      case 'ÁªøËâ≤': return '#008000';
      case 'ÈùíËâ≤': return '#00FFFF';
      case 'ËìùËâ≤': return '#0000FF';
      case 'Á¥´Ëâ≤': return '#800080';
      case 'Á≤âËâ≤': return '#FFC0CB';
      case 'ÁôΩËâ≤': return '#000000'; // Use black for text visibility on white bg, or gray
      case 'ÈáëËâ≤': return '#FFD700';
      default: return '#000000';
    }
  }
}
