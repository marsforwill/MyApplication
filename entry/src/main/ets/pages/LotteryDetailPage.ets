import { router } from '@kit.ArkUI';
import { vibrator } from '@kit.SensorServiceKit';
import { LotteryStick, getLevelText, getLevelColor } from '../models/LotteryStick';

/**
 * ç­¾æ–‡è¯¦æƒ…é¡µ
 * å±•ç¤ºå®Œæ•´çš„è§£ç­¾å†…å®¹
 */
@Entry
@Component
struct LotteryDetailPage {
  @State stick: LotteryStick | null = null;
  @State userQuestion: string = '';

  aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>;
    if (params) {
      this.stick = params['stick'] as LotteryStick;
      this.userQuestion = params['question'] as string || '';
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor($r('app.color.text_primary'))
          .fontWeight(FontWeight.Bold)
          .onClick(() => {
            try {
              vibrator.startVibration({
                type: 'time',
                duration: 30
              }, {
                usage: 'touch'
              });
            } catch (error) {
              console.error('Vibration error:', error);
            }
            router.back();
          })

        Text('ğŸ“œ ç­¾æ–‡è¯¦è§£')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .margin({ left: 12 })
      }
      .width('100%')
      .padding({ top: 20, left: 20, right: 20, bottom: 10 })

      if (this.stick) {
        Scroll() {
          Column() {
            // ç”¨æˆ·é—®é¢˜
            if (this.userQuestion) {
              Column() {
                Text('æ‚¨çš„é—®é¢˜')
                  .fontSize(14)
                  .fontColor($r('app.color.text_hint'))
                  .margin({ bottom: 8 })
                  .width('100%')

                Text(this.userQuestion)
                  .fontSize(16)
                  .fontColor($r('app.color.text_primary'))
                  .width('100%')
              }
              .width('100%')
              .padding(16)
              .backgroundColor($r('app.color.background_secondary'))
              .borderRadius(12)
              .margin({ bottom: 20 })
            }

            // ç­¾å·å’Œç­‰çº§
            Text(this.stick.name + ' Â· ' + getLevelText(this.stick.level))
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor(getLevelColor(this.stick.level))
              .margin({ bottom: 20 })
              .textAlign(TextAlign.Center)
              .width('100%')

            // ç­¾æ–‡è¯—å¥
            Column() {
              Text('ç­¾æ–‡')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.text_secondary'))
                .margin({ bottom: 12 })
                .width('100%')

              Text(this.stick.poem)
                .fontSize(18)
                .fontColor($r('app.color.text_primary'))
                .lineHeight(32)
                .textAlign(TextAlign.Center)
                .width('100%')
                .fontFamily('serif')
            }
            .width('100%')
            .padding(20)
            .backgroundColor($r('app.color.background_secondary'))
            .borderRadius(12)
            .margin({ bottom: 20 })

            // æ€»ä½“å«ä¹‰
            this.buildSection('æ€»ä½“å«ä¹‰', this.stick.meaning)

            // è¯¦ç»†è§£ç­¾
            this.buildSection('è¯¦ç»†è§£ç­¾', this.stick.detail)

            // åˆ†ç±»è¿åŠ¿
            Column() {
              Text('åˆ†ç±»è¿åŠ¿')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary'))
                .margin({ bottom: 16 })
                .width('100%')

              // å§»ç¼˜è¿åŠ¿
              this.buildFortuneItem('ğŸ’• å§»ç¼˜è¿åŠ¿', this.stick.love)

              // äº‹ä¸šè¿åŠ¿
              this.buildFortuneItem('ğŸ’¼ äº‹ä¸šè¿åŠ¿', this.stick.career)

              // è´¢è¿
              this.buildFortuneItem('ğŸ’° è´¢è¿', this.stick.wealth)

              // å¥åº·è¿åŠ¿
              this.buildFortuneItem('ğŸ¥ å¥åº·è¿åŠ¿', this.stick.health)
            }
            .width('100%')
            .padding(20)
            .backgroundColor($r('app.color.background_secondary'))
            .borderRadius(12)
            .margin({ bottom: 20 })

            // æ¸©é¦¨æç¤º
            Column() {
              Text('ğŸ“Œ æ¸©é¦¨æç¤º')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor($r('app.color.text_primary'))
                .margin({ bottom: 10 })
                .width('100%')

              Text('ç­¾æ–‡ä»…ä¾›å‚è€ƒï¼Œå‘½è¿æŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­ã€‚ä¿æŒç§¯æå¿ƒæ€ï¼ŒåŠªåŠ›å¥‹æ–—ï¼Œæ–¹èƒ½åˆ›é€ ç¾å¥½æœªæ¥ã€‚')
                .fontSize(14)
                .fontColor($r('app.color.text_hint'))
                .lineHeight(22)
                .width('100%')
            }
            .width('100%')
            .padding(16)
            .backgroundColor('rgba(255, 193, 7, 0.1)')
            .borderRadius(12)
            .margin({ bottom: 20 })

            // è¿”å›æŒ‰é’®
            Button('è¿”å›é¦–é¡µ')
              .type(ButtonType.Normal)
              .backgroundColor($r('app.color.button_primary'))
              .fontColor(Color.White)
              .fontSize(16)
              .width('100%')
              .height(50)
              .borderRadius(25)
              .margin({ top: 10, bottom: 20 })
              .onClick(() => {
                router.back();
              })
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 10, bottom: 40 })
        }
        .width('100%')
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_primary'))
  }

  /**
   * æ„å»ºå†…å®¹åŒºå—
   */
  @Builder
  buildSection(title: string, content: string) {
    Column() {
      Text(title)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .margin({ bottom: 12 })
        .width('100%')

      Text(content)
        .fontSize(15)
        .fontColor($r('app.color.text_secondary'))
        .lineHeight(26)
        .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor($r('app.color.background_secondary'))
    .borderRadius(12)
    .margin({ bottom: 20 })
  }

  /**
   * æ„å»ºè¿åŠ¿æ¡ç›®
   */
  @Builder
  buildFortuneItem(title: string, content: string) {
    Column() {
      Text(title)
        .fontSize(15)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .margin({ bottom: 8 })
        .width('100%')

      Text(content)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .lineHeight(24)
        .width('100%')
    }
    .width('100%')
    .margin({ bottom: 16 })
  }
}
