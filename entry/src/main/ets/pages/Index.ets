import { router } from '@kit.ArkUI';
import {
  SpreadType,
  ReadingResult,
  DrawnCard,
  drawMultipleCards,
  generateSingleCardReading,
  generateThreeCardReading,
  generateSevenCardReading,
  TAROT_CARDS,
  TarotCard
} from '../models/TarotCard';

/**
 * é¦–é¡µç»„ä»¶
 * å±•ç¤ºé—®é¢˜è¾“å…¥ã€ç‰Œé˜µé€‰æ‹©ï¼Œç„¶åŽè¿›è¡Œå åœ
 */
@Entry
@Component
struct Index {
  // ç”¨æˆ·è¾“å…¥çš„é—®é¢˜
  @State userQuestion: string = '';
  // é€‰æ‹©çš„ç‰Œé˜µç±»åž‹
  @State selectedSpread: SpreadType | null = null;
  // æ˜¯å¦å·²å¼€å§‹å åœï¼ˆæ˜¾ç¤ºæŠ½ç‰Œç»“æžœï¼‰
  @State hasStartedReading: boolean = false;
  // å åœç»“æžœ
  @State readingResult: ReadingResult | null = null;
  // æ˜¯å¦æ˜¾ç¤ºå¡ç‰Œä¿¡æ¯ï¼ˆç”¨äºŽæ·¡å…¥åŠ¨ç”»ï¼‰
  @State showCardInfo: boolean = false;
  @State flippedCardIds: number[] = [];

  // æ¯æ—¥è¿åŠ¿ç›¸å…³
  @StorageLink('dailyCardDate') dailyCardDate: string = '';
  @StorageLink('dailyCardId') dailyCardId: number = -1;
  @State dailyCard: TarotCard | null = null;

  aboutToAppear() {
    this.checkDailyCard();
  }

  checkDailyCard() {
    const today = new Date().toDateString();
    if (this.dailyCardDate === today && this.dailyCardId !== -1) {
      // ä»Šå¤©å·²ç»æŠ½è¿‡ç‰Œ
      this.dailyCard = TAROT_CARDS.find(card => card.id === this.dailyCardId) || null;
    } else {
      // æ–°çš„ä¸€å¤©ï¼Œé‡ç½®
      if (this.dailyCardDate !== today) {
        this.dailyCardDate = '';
        this.dailyCardId = -1;
        this.dailyCard = null;
      }
    }
  }

  drawDailyCard() {
    // éšæœºæŠ½å–ä¸€å¼ ç‰Œ
    const randomIndex = Math.floor(Math.random() * TAROT_CARDS.length);
    const card = TAROT_CARDS[randomIndex];
    
    // ä¿å­˜ç»“æžœ
    this.dailyCardId = card.id;
    this.dailyCardDate = new Date().toDateString();
    this.dailyCard = card;
  }

  /**
   * å¼€å§‹å åœ
   */
  startReading() {
    // éªŒè¯è¾“å…¥
    if (!this.userQuestion.trim()) {
      // å¯ä»¥æ·»åŠ æç¤º
      return;
    }
    if (!this.selectedSpread) {
      // å¯ä»¥æ·»åŠ æç¤º
      return;
    }

    // é‡ç½®çŠ¶æ€
    this.hasStartedReading = true;
    this.showCardInfo = false;
    this.flippedCardIds = [];

    // æ ¹æ®ç‰Œé˜µç±»åž‹æŠ½å–å¡ç‰Œ
    let result: ReadingResult;
    const cards = drawMultipleCards(this.selectedSpread!);

    if (this.selectedSpread === SpreadType.SINGLE) {
      result = generateSingleCardReading(this.userQuestion, cards[0]);
    } else if (this.selectedSpread === SpreadType.THREE) {
      result = generateThreeCardReading(this.userQuestion, cards);
    } else {
      result = generateSevenCardReading(this.userQuestion, cards);
    }

    this.readingResult = result;

    // å»¶è¿Ÿæ˜¾ç¤ºå¡ç‰Œä¿¡æ¯ï¼Œå®žçŽ°æ·¡å…¥æ•ˆæžœ
    setTimeout(() => {
      this.showCardInfo = true;
    }, 300);
  }

  /**
   * é‡æ–°å¼€å§‹å åœ
   */
  resetReading() {
    this.hasStartedReading = false;
    this.readingResult = null;
    this.showCardInfo = false;
    this.flippedCardIds = [];
    // ä¿ç•™é—®é¢˜å’Œç‰Œé˜µé€‰æ‹©
  }

  handleCardFlip(cardId: number) {
    if (this.flippedCardIds.includes(cardId)) {
      return;
    }
    this.flippedCardIds = [...this.flippedCardIds, cardId];
  }

  isCardFlipped(cardId: number): boolean {
    return this.flippedCardIds.includes(cardId);
  }

  build() {
    Stack() {
      // èƒŒæ™¯å›¾ç‰‡ - ä½¿ç”¨ Image ç»„ä»¶ç¡®ä¿æ­£ç¡®æ˜¾ç¤º
      Image($r('app.media.background'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)
        .alt($r('app.media.background'))

      // å†…å®¹å±‚
      Scroll() {
        Column() {
          // åº”ç”¨æ ‡é¢˜
          Text($r('app.string.app_title'))
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))
            .margin({ top: 40, bottom: 30 })
            .opacity(0.95)

          // æ¯æ—¥è¿åŠ¿å¡ç‰‡
          if (!this.hasStartedReading) {
            this.buildDailyTarotSection()
          }

          if (!this.hasStartedReading) {
            // é—®é¢˜è¾“å…¥å’Œç‰Œé˜µé€‰æ‹©ç•Œé¢
            this.buildQuestionInput()
          } else if (this.readingResult) {
            // å åœç»“æžœç•Œé¢
            this.buildReadingResult(this.readingResult)
          }
        }
        .width('100%')
        .padding({ left: 20, right: 20, bottom: 40 })
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
  }

  /**
   * æž„å»ºåŠŸèƒ½æŒ‰é’®
   */
  @Builder
  buildFeatureButton(icon: string, title: string, url: string) {
    Column() {
      Text(icon)
        .fontSize(32)
        .margin({ bottom: 4 })

      Text(title)
        .fontSize(12)
        .fontColor($r('app.color.text_secondary'))
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_secondary'))
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      router.pushUrl({ url: url });
    })
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 2
    })
    .animation({
      duration: 200,
      curve: Curve.Sharp
    })
  }

  /**
   * æž„å»ºé—®é¢˜è¾“å…¥å’Œç‰Œé˜µé€‰æ‹©ç•Œé¢
   */
  @Builder
  buildQuestionInput() {
    Column() {
      // é—®é¢˜è¾“å…¥åŒºåŸŸ
      Column() {
        Text($r('app.string.enter_question'))
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .margin({ bottom: 12 })
          .width('100%')
          .textAlign(TextAlign.Start)

        TextInput({ placeholder: $r('app.string.question_placeholder') })
          .width('100%')
          .height(50)
          .backgroundColor($r('app.color.background_secondary'))
          .borderRadius(12)
          .padding({ left: 16, right: 16 })
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .onChange((value: string) => {
            this.userQuestion = value;
          })
      }
      .width('100%')
      .margin({ bottom: 30 })

      // ç‰Œé˜µé€‰æ‹©åŒºåŸŸ
      Column() {
        Text($r('app.string.select_spread'))
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .margin({ bottom: 16 })
          .width('100%')
          .textAlign(TextAlign.Start)

        // å•å¼ ç‰Œé€‰é¡¹
        Row() {
          Text($r('app.string.spread_single'))
            .fontSize(16)
            .fontColor(this.selectedSpread === SpreadType.SINGLE ? Color.White : $r('app.color.text_primary'))
        }
        .width('100%')
        .height(50)
        .backgroundColor(this.selectedSpread === SpreadType.SINGLE ? $r('app.color.button_primary') :
          $r('app.color.background_secondary'))
        .borderRadius(12)
        .justifyContent(FlexAlign.Center)
        .margin({ bottom: 12 })
        .onClick(() => {
          this.selectedSpread = SpreadType.SINGLE;
        })

        // ä¸‰å¼ ç‰Œé€‰é¡¹
        Row() {
          Text($r('app.string.spread_three'))
            .fontSize(16)
            .fontColor(this.selectedSpread === SpreadType.THREE ? Color.White : $r('app.color.text_primary'))
        }
        .width('100%')
        .height(50)
        .backgroundColor(this.selectedSpread === SpreadType.THREE ? $r('app.color.button_primary') :
          $r('app.color.background_secondary'))
        .borderRadius(12)
        .justifyContent(FlexAlign.Center)
        .margin({ bottom: 12 })
        .onClick(() => {
          this.selectedSpread = SpreadType.THREE;
        })

        // ä¸ƒå¼ ç‰Œé€‰é¡¹
        Row() {
          Text($r('app.string.spread_seven'))
            .fontSize(16)
            .fontColor(this.selectedSpread === SpreadType.SEVEN ? Color.White : $r('app.color.text_primary'))
        }
        .width('100%')
        .height(50)
        .backgroundColor(this.selectedSpread === SpreadType.SEVEN ? $r('app.color.button_primary') :
          $r('app.color.background_secondary'))
        .borderRadius(12)
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.selectedSpread = SpreadType.SEVEN;
        })
      }
      .width('100%')
      .margin({ bottom: 30 })

      // åŠŸèƒ½å…¥å£åŒºåŸŸ - ç½‘æ ¼å¸ƒå±€
      Column() {
        Text('æ›´å¤šåŠŸèƒ½')
          .fontSize(14)
          .fontColor($r('app.color.text_hint'))
          .margin({ bottom: 12 })
          .width('100%')
          .textAlign(TextAlign.Start)

        // åŠŸèƒ½æŒ‰é’®ç½‘æ ¼
        Grid() {
          GridItem() {
            this.buildFeatureButton('ðŸ”®', 'å¡”ç½—ç‰Œåº“', 'pages/CardLibrary')
          }

          GridItem() {
            this.buildFeatureButton('ðŸ™', 'è§‚éŸ³çµç­¾', 'pages/LotteryPage')
          }

          GridItem() {
            this.buildFeatureButton('â˜¯ï¸', 'å…«å­—åˆ†æž', 'pages/BaZiPage')
          }
        }
        .columnsTemplate('1fr 1fr 1fr')
        .rowsGap(12)
        .columnsGap(12)
        .width('100%')
        .height(100)
      }
      .width('100%')
      .margin({ bottom: 20 })

      // å¼€å§‹å åœæŒ‰é’®
      Button($r('app.string.start_reading'))
        .type(ButtonType.Normal)
        .backgroundColor($r('app.color.button_primary'))
        .fontColor(Color.White)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .width('100%')
        .height(56)
        .borderRadius(28)
        .enabled(this.userQuestion.trim().length > 0 && this.selectedSpread !== null)
        .opacity((this.userQuestion.trim().length > 0 && this.selectedSpread !== null) ? 1 : 0.5)
        .shadow((this.userQuestion.trim().length > 0 && this.selectedSpread !== null) ? {
          radius: 20,
          color: 'rgba(107, 70, 193, 0.4)',
          offsetX: 0,
          offsetY: 8
        } : {
          radius: 0,
          color: Color.Transparent,
          offsetX: 0,
          offsetY: 0
        })
        .onClick(() => {
          this.startReading();
        })
    }
    .width('100%')
    .justifyContent(FlexAlign.Start)
  }

  /**
   * æž„å»ºå åœç»“æžœç•Œé¢
   */
  @Builder
  buildReadingResult(reading: ReadingResult) {
    Column() {
      this.buildQuestionSummary(reading.question)

      if (reading.spreadType === SpreadType.SINGLE && reading.cards.length >= 1) {
        this.buildSingleCardSection(reading.cards[0])
      } else if (reading.spreadType === SpreadType.THREE && reading.cards.length >= 3) {
        this.buildThreeCardSection(reading.cards)
      } else if (reading.spreadType === SpreadType.SEVEN && reading.cards.length >= 7) {
        this.buildSevenCardSection(reading.cards)
      }

      if (this.showCardInfo) {
        Column() {
          Button($r('app.string.view_details'))
            .type(ButtonType.Normal)
            .backgroundColor($r('app.color.button_primary'))
            .fontColor(Color.White)
            .fontSize(16)
            .margin({ top: 30 })
            .borderRadius(20)
            .width(160)
            .height(44)
            .onClick(() => {
              router.pushUrl({
                url: 'pages/ResultPage',
                params: {
                  readingResult: reading
                }
              });
            })
            .opacity(1)

          Button($r('app.string.draw_again'))
            .type(ButtonType.Normal)
            .backgroundColor($r('app.color.button_secondary'))
            .fontColor($r('app.color.text_primary'))
            .fontSize(16)
            .margin({ top: 20 })
            .borderRadius(20)
            .width(160)
            .height(44)
            .onClick(() => {
              this.resetReading();
            })
            .opacity(1)
        }
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .width('100%')
        .transition(TransitionEffect.OPACITY.animation({ duration: 400, curve: Curve.EaseInOut }))
      }
    }
    .width('100%')
  }

  /**
   * æ˜¾ç¤ºç”¨æˆ·é—®é¢˜æ‘˜è¦
   */
  @Builder
  buildQuestionSummary(question: string) {
    Column() {
      Text($r('app.string.your_question'))
        .fontSize(14)
        .fontColor($r('app.color.text_hint'))
        .margin({ bottom: 8 })
      Text(question)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .textAlign(TextAlign.Center)
        .padding({ left: 20, right: 20 })
    }
    .width('100%')
    .padding({ top: 20, bottom: 20 })
    .backgroundColor($r('app.color.background_secondary'))
    .borderRadius(12)
    .margin({ bottom: 30 })
    .opacity(this.showCardInfo ? 1 : 0)
    .transition(TransitionEffect.OPACITY.animation({ duration: 400, curve: Curve.EaseInOut }))
  }

  /**
   * æž„å»ºå•å¼ ç‰Œæ˜¾ç¤º
   */
  @Builder
  buildSingleCardSection(card: DrawnCard) {
    Column() {
      this.buildFlipCard(card, 220, 350, 18, true, this.isCardFlipped(card.card.id))

      if (this.showCardInfo && this.isCardFlipped(card.card.id)) {
        Text(card.card.name)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .margin({ top: 20, bottom: 12 })
        Text(card.card.description)
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
          .textAlign(TextAlign.Center)
          .padding({ left: 30, right: 30 })
          .lineHeight(24)
      }
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  /**
   * æž„å»ºä¸ƒå¼ ç‰Œæ˜¾ç¤º
   */
  @Builder
  buildThreeCardSection(cards: DrawnCard[]) {
    Row() {
      this.buildThreeCardItem(cards[0])
      this.buildThreeCardItem(cards[1])
      this.buildThreeCardItem(cards[2])
    }
    .width('100%')
    .justifyContent(FlexAlign.SpaceEvenly)
    .padding({ left: 10, right: 10 })
    .margin({ bottom: 20 })
  }

  @Builder
  buildThreeCardItem(card: DrawnCard) {
    Column() {
      this.buildFlipCard(card, 85, 136, 10, false, this.isCardFlipped(card.card.id))

      if (this.showCardInfo && this.isCardFlipped(card.card.id)) {
        Text(card.positionLabel || '')
          .fontSize(11)
          .fontColor($r('app.color.text_hint'))
          .margin({ top: 6 })
        Text(card.card.name)
          .fontSize(13)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .margin({ top: 3 })
          .textAlign(TextAlign.Center)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .width('100%')
      }
    }
    .width(85)
  }

  /**
   * æž„å»ºä¸ƒå¼ ç‰Œæ˜¾ç¤º
   */
  @Builder
  buildSevenCardSection(cards: DrawnCard[]) {
    Column() {
      Row() {
        this.buildSevenCardItem(cards[0])
        this.buildSevenCardItem(cards[1])
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceEvenly)
      .margin({ bottom: 12 })

      Row() {
        this.buildSevenCardItem(cards[2])
        this.buildSevenCardItem(cards[3])
        this.buildSevenCardItem(cards[4])
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceEvenly)
      .margin({ bottom: 12 })

      Row() {
        this.buildSevenCardItem(cards[5])
        this.buildSevenCardItem(cards[6])
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceEvenly)
    }
    .width('100%')
    .margin({ bottom: 20 })
  }

  /**
   * æž„å»ºå•å¼ å¡ç‰Œé¡¹ï¼ˆç”¨äºŽä¸ƒå¼ ç‰Œå¸ƒå±€ï¼‰
   */
  @Builder
  buildSevenCardItem(card: DrawnCard) {
    Column() {
      this.buildFlipCard(card, 96, 154, 10, false, this.isCardFlipped(card.card.id))

      if (this.showCardInfo && this.isCardFlipped(card.card.id)) {
        Text(card.positionLabel || '')
          .fontSize(10)
          .fontColor($r('app.color.text_hint'))
          .margin({ top: 6 })
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
        Text(card.card.name)
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .margin({ top: 4 })
          .textAlign(TextAlign.Center)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
    }
    .width(96)
  }

  @Builder
  buildFlipCard(card: DrawnCard, width: number, height: number, borderRadius: number = 12, showShadow: boolean = false,
    flipped: boolean = false) {
    Stack() {
      Image($r('app.media.card_back'))
        .width(width)
        .height(height)
        .borderRadius(borderRadius)
        .opacity((this.showCardInfo ? 1 : 0) * (flipped ? 0 : 1))
        .rotate({ x: 0, y: 1, z: 0, angle: flipped ? 180 : 0 })
        .animation({ duration: 280, curve: Curve.EaseInOut })

      Image(card.card.image)
        .width(width)
        .height(height)
        .borderRadius(borderRadius)
        .opacity((this.showCardInfo ? 1 : 0) * (flipped ? 1 : 0))
        .rotate({ x: 0, y: 1, z: 0, angle: flipped ? 0 : -180 })
        .animation({ duration: 280, curve: Curve.EaseInOut })
    }
    .width(width)
    .height(height)
    .borderRadius(borderRadius)
    .shadow(showShadow ? {
      radius: 25,
      color: $r('app.color.card_shadow'),
      offsetX: 0,
      offsetY: 15
    } : {
      radius: 0,
      color: Color.Transparent,
      offsetX: 0,
      offsetY: 0
    })
    .scale({ x: flipped ? 1 : 0.96, y: flipped ? 1 : 0.96, z: 1 })
    .opacity(this.showCardInfo ? 1 : 0)
    .transition(TransitionEffect.OPACITY.animation({ duration: 400, curve: Curve.EaseInOut }))
    .onClick(() => {
      if (!this.showCardInfo || flipped) {
        return;
      }
      animateTo({ duration: 300, curve: Curve.EaseInOut }, () => {
        this.handleCardFlip(card.card.id);
      })
    })
  }

  /**
   * æž„å»ºæ¯æ—¥è¿åŠ¿åŒºåŸŸ
   */
  @Builder
  buildDailyTarotSection() {
    Column() {
      Row() {
        Text('ðŸŒŸ æ¯æ—¥è¿åŠ¿')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
        
        Blank()
        
        Text(new Date().toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' }))
          .fontSize(12)
          .fontColor($r('app.color.text_hint'))
      }
      .width('100%')
      .margin({ bottom: 12 })

      if (this.dailyCard) {
        // å·²æŠ½ç‰Œå±•ç¤º
        Row() {
          Image(this.dailyCard.image)
            .width(70)
            .height(112)
            .borderRadius(8)
            .margin({ right: 16 })
            .shadow({
              radius: 12,
              color: 'rgba(0,0,0,0.15)',
              offsetX: 0,
              offsetY: 4
            })

          Column() {
            Text(this.dailyCard.name)
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 6 })
            
            Text(this.dailyCard.description)
              .fontSize(13)
              .fontColor($r('app.color.text_secondary'))
              .lineHeight(20)
              .maxLines(3)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)
          
          // è·³è½¬è¯¦æƒ…ç®­å¤´
          Text('>')
            .fontSize(20)
            .fontColor($r('app.color.text_hint'))
            .margin({ left: 8 })
        }
        .width('100%')
        .padding(16)
        .backgroundColor($r('app.color.background_secondary'))
        .borderRadius(16)
        .shadow({
          radius: 15,
          color: 'rgba(0,0,0,0.08)',
          offsetX: 0,
          offsetY: 4
        })
        .onClick(() => {
          router.pushUrl({
            url: 'pages/ResultPage',
            params: {
              cardId: this.dailyCard?.id
            }
          });
        })
      } else {
        // æœªæŠ½ç‰Œå±•ç¤º
        Column() {
          Text('âœ¨')
            .fontSize(40)
            .margin({ bottom: 8 })
          
          Text('ä»Šå¤©è¿˜æ²¡æœ‰æŠ½å–è¿åŠ¿ç‰Œ')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
            .margin({ bottom: 16 })
          
          Button('ðŸŽ´ æŠ½å–ä»Šæ—¥è¿åŠ¿')
            .type(ButtonType.Normal)
            .backgroundColor($r('app.color.button_primary'))
            .fontColor(Color.White)
            .fontSize(15)
            .height(44)
            .borderRadius(22)
            .onClick(() => {
              this.drawDailyCard();
            })
        }
        .width('100%')
        .padding(24)
        .backgroundColor($r('app.color.background_secondary'))
        .borderRadius(16)
        .justifyContent(FlexAlign.Center)
        .shadow({
          radius: 15,
          color: 'rgba(0,0,0,0.08)',
          offsetX: 0,
          offsetY: 4
        })
      }
    }
    .width('100%')
    .margin({ bottom: 30 })
  }
}
